<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Laporan - PPN Tegalsari</title>

    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <!-- Header -->
    <header class="ppn-header">
        <div class="container-fluid">
            <a href="/" class="header-link">
                <div class="header-content">
                    <div class="logo-section">
                        <img src="/images/logo.png" alt="Logo PPN Tegalsari" class="ppn-logo">
                    </div>
                    <div class="institution-section">
                        <h1>PELABUHAN PERIKANAN NUSANTARA</h1>
                        <h2>TEGALSARI</h2>
                    </div>
                </div>
            </a>
        </div>
    </header>

    <!-- Navigation Menu -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">Dashboard Laporan</a>
            <a class="navbar-brand" href="/">PPN Tegalsari</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/">Beranda</a>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle active" href="#" id="pelaporan" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            Pelaporan
                        </a>
                        <ul class="dropdown-menu" aria-labelledby="pelaporan">
                            <li><a class="dropdown-item" href="/input-laporan-harian">Infografis</a></li>
                            <li><a class="dropdown-item" href="/laporan-ikan">Laporan Ikan</a></li>
                        </ul>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/login">Login</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Container -->
    <div class="container-main">
        <!-- Page Header -->
        <div class="page-header">
            <h1>Dashboard Laporan</h1>
            <p>Rekap data harian, bulanan, dan tahunan PPN Tegalsari</p>
        </div>

        <!-- Alert Container -->
        <div id="alertContainer"></div>

        <!-- Tab Navigation -->
        <ul class="nav nav-tabs mb-4" id="dashboardTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="tab-harian" data-bs-toggle="tab" data-bs-target="#content-harian" type="button" role="tab">
                    ðŸ“… Data Harian
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="tab-bulanan" data-bs-toggle="tab" data-bs-target="#content-bulanan" type="button" role="tab">
                    ðŸ“Š Data Bulanan
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="tab-tahunan" data-bs-toggle="tab" data-bs-target="#content-tahunan" type="button" role="tab">
                    ðŸ“ˆ Data Tahunan
                </button>
            </li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content" id="dashboardTabContent">
            <!-- Tab Harian -->
            <div class="tab-pane fade show active" id="content-harian" role="tabpanel">
                <!-- Day Selector -->
                <div class="card shadow-sm mb-4">
                    <div class="card-body p-4">
                        <div class="row align-items-center">
                            <div class="col-md-4">
                                <label for="daySelector" class="form-label fw-bold">Pilih Tanggal:</label>
                                <input type="date" id="daySelector" class="form-control" onchange="loadHarianData()">
                            </div>
                            <div class="col-md-8">
                                <p class="text-muted mb-0">Pilih tanggal untuk melihat data pelaporan pada hari tersebut</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card dashboard-card shadow-sm mb-4">
                    <div class="card-body p-4">
                        <h5 class="card-title mb-4">ðŸ“… Grafik Data Harian</h5>
                        <div style="position: relative; height: 350px;">
                            <canvas id="chartHarian"></canvas>
                        </div>
                    </div>
                </div>

                <div class="card shadow-sm">
                    <div class="card-header bg-gradient d-flex justify-content-between align-items-center">
                        <span class="fw-bold">ðŸ“‹ Data Pelaporan Harian</span>
                        <button class="btn btn-sm btn-light fw-bold" onclick="loadHarianData()">ðŸ”„ Refresh</button>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th class="fw-bold">Kategori</th>
                                        <th class="text-end fw-bold">Jumlah</th>
                                        <th class="text-end fw-bold">Persentase</th>
                                    </tr>
                                </thead>
                                <tbody id="tableHarianBody">
                                    <tr>
                                        <td colspan="3" class="text-center text-muted py-4">Memuat data...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab Bulanan -->
            <div class="tab-pane fade" id="content-bulanan" role="tabpanel">
                <!-- Month Selector -->
                <div class="card shadow-sm mb-4">
                    <div class="card-body p-4">
                        <div class="row align-items-center">
                            <div class="col-md-4">
                                <label for="monthSelector" class="form-label fw-bold">Pilih Bulan:</label>
                                <input type="month" id="monthSelector" class="form-control" onchange="loadBulanData()">
                            </div>
                            <div class="col-md-8">
                                <p class="text-muted mb-0">Pilih bulan untuk melihat data pelaporan bulanan tersebut</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card dashboard-card shadow-sm mb-4">
                    <div class="card-body p-4">
                        <h5 class="card-title mb-4">ðŸ“Š Grafik Data Bulanan</h5>
                        <div style="position: relative; height: 350px;">
                            <canvas id="chartBulanan"></canvas>
                        </div>
                    </div>
                </div>

                <div class="card shadow-sm">
                    <div class="card-header bg-gradient d-flex justify-content-between align-items-center">
                        <span class="fw-bold">ðŸ“‹ Data Pelaporan Bulanan</span>
                        <button class="btn btn-sm btn-light fw-bold" onclick="loadBulanData()">ðŸ”„ Refresh</button>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th class="fw-bold">Minggu</th>
                                        <th class="text-end fw-bold">Total</th>
                                        <th class="text-end fw-bold">Rata-Rata</th>
                                    </tr>
                                </thead>
                                <tbody id="tableBulanBody">
                                    <tr>
                                        <td colspan="3" class="text-center text-muted py-4">Memuat data...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab Tahunan -->
            <div class="tab-pane fade" id="content-tahunan" role="tabpanel">
                <!-- Year Selector -->
                <div class="card shadow-sm mb-4">
                    <div class="card-body p-4">
                        <div class="row align-items-center">
                            <div class="col-md-4">
                                <label for="yearSelector" class="form-label fw-bold">Pilih Tahun:</label>
                                <input type="number" id="yearSelector" class="form-control" min="2020" max="2030" onchange="loadTahunData()">
                            </div>
                            <div class="col-md-8">
                                <p class="text-muted mb-0">Pilih tahun untuk melihat data pelaporan tahunan tersebut</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card dashboard-card shadow-sm mb-4">
                    <div class="card-body p-4">
                        <h5 class="card-title mb-4">ðŸ“ˆ Grafik Data Tahunan</h5>
                        <div style="position: relative; height: 350px;">
                            <canvas id="chartTahunan"></canvas>
                        </div>
                    </div>
                </div>

                <div class="card shadow-sm">
                    <div class="card-header bg-gradient d-flex justify-content-between align-items-center">
                        <span class="fw-bold">ðŸ“‹ Data Pelaporan Tahunan</span>
                        <button class="btn btn-sm btn-light fw-bold" onclick="loadTahunData()">ðŸ”„ Refresh</button>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th class="fw-bold">Bulan</th>
                                        <th class="text-end fw-bold">Total</th>
                                        <th class="text-end fw-bold">Rata-Rata</th>
                                    </tr>
                                </thead>
                                <tbody id="tableTahunBody">
                                    <tr>
                                        <td colspan="3" class="text-center text-muted py-4">Memuat data...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <div class="footer">
        <p>&copy; 2025 PPN Tegalsari. Semua hak dilindungi.</p>
    </div>

    <!-- Bootstrap 5 JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Custom JS -->
    <script src="/js/admin.js"></script>
    
    <script>
        let charts = {};

        // Initialize charts on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Set today's date as default for harian
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('daySelector').value = today;
            
            // Set current month as default for bulanan
            const currentMonth = new Date().toISOString().slice(0, 7);
            document.getElementById('monthSelector').value = currentMonth;
            
            // Set current year as default for tahunan
            const currentYear = new Date().getFullYear();
            document.getElementById('yearSelector').value = currentYear;
            
            initCharts();
        });

        function initCharts() {
            // Chart configuration
            const chartOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            };

            // Chart Harian
            const ctxHarian = document.getElementById('chartHarian').getContext('2d');
            charts.harian = new Chart(ctxHarian, {
                type: 'bar',
                data: {
                    labels: ['STBLKK', 'PB', 'Asuransi Baru', 'Asuransi Lama', 'BBM Subsidi', 'BBM Non-Subsidi'],
                    datasets: [{
                        label: 'Pelaporan',
                        data: [25, 15, 30, 12, 35, 20],
                        backgroundColor: [
                            '#1e3a8a',
                            '#3b82f6',
                            '#10b981',
                            '#f59e0b',
                            '#ef4444',
                            '#0891b2'
                        ],
                        borderRadius: 5,
                        borderSkipped: false
                    }]
                },
                options: {
                    ...chartOptions,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'bottom'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 10
                            }
                        }
                    }
                }
            });

            // Chart Bulanan
            const ctxBulanan = document.getElementById('chartBulanan').getContext('2d');
            charts.bulanan = new Chart(ctxBulanan, {
                type: 'bar',
                data: {
                    labels: ['Minggu 1', 'Minggu 2', 'Minggu 3', 'Minggu 4'],
                    datasets: [
                        {
                            label: 'STBLKK',
                            data: [45, 50, 48, 55],
                            backgroundColor: '#1e3a8a'
                        },
                        {
                            label: 'PB',
                            data: [38, 42, 40, 48],
                            backgroundColor: '#3b82f6'
                        },
                        {
                            label: 'Asuransi Baru',
                            data: [52, 58, 55, 65],
                            backgroundColor: '#10b981'
                        },
                        {
                            label: 'Asuransi Lama',
                            data: [28, 32, 30, 38],
                            backgroundColor: '#f59e0b'
                        },
                        {
                            label: 'BBM Subsidi',
                            data: [65, 72, 68, 80],
                            backgroundColor: '#ef4444'
                        },
                        {
                            label: 'BBM Non-Subsidi',
                            data: [42, 48, 45, 55],
                            backgroundColor: '#0891b2'
                        }
                    ]
                },
                options: {
                    ...chartOptions,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'bottom'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 10
                            }
                        },
                        x: {
                            stacked: false
                        }
                    }
                }
            });

            // Chart Tahunan
            const ctxTahunan = document.getElementById('chartTahunan').getContext('2d');
            charts.tahunan = new Chart(ctxTahunan, {
                type: 'bar',
                data: {
                    labels: ['Jan', 'Feb', 'Mar', 'Apr', 'Mei', 'Jun', 'Jul', 'Agu', 'Sep', 'Okt', 'Nov', 'Des'],
                    datasets: [
                        {
                            label: 'STBLKK',
                            data: [70, 75, 72, 78, 80, 82, 85, 83, 81, 79, 77, 75],
                            backgroundColor: '#1e3a8a'
                        },
                        {
                            label: 'PB',
                            data: [60, 65, 62, 68, 70, 72, 75, 73, 71, 69, 67, 65],
                            backgroundColor: '#3b82f6'
                        },
                        {
                            label: 'Asuransi Baru',
                            data: [75, 80, 77, 83, 85, 87, 90, 88, 86, 84, 82, 80],
                            backgroundColor: '#10b981'
                        },
                        {
                            label: 'Asuransi Lama',
                            data: [40, 42, 41, 45, 47, 49, 52, 50, 48, 46, 44, 42],
                            backgroundColor: '#f59e0b'
                        },
                        {
                            label: 'BBM Subsidi',
                            data: [85, 90, 87, 93, 95, 97, 100, 98, 96, 94, 92, 90],
                            backgroundColor: '#ef4444'
                        },
                        {
                            label: 'BBM Non-Subsidi',
                            data: [55, 60, 57, 63, 65, 67, 70, 68, 66, 64, 62, 60],
                            backgroundColor: '#0891b2'
                        }
                    ]
                },
                options: {
                    ...chartOptions,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'bottom'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 10
                            }
                        },
                        x: {
                            stacked: false
                        }
                    }
                }
            });
        }

        // Load functions for data
        function loadHarianData() {
            try {
                const selectedDate = document.getElementById('daySelector').value;
                const chartInstance = charts.harian;
                
                if (!selectedDate || !chartInstance) return;

                // Generate random data for the selected day
                const categories = ['STBLKK', 'PB', 'Asuransi Baru', 'Asuransi Lama', 'BBM Subsidi', 'BBM Non-Subsidi'];
                const mockData = {};
                
                categories.forEach(cat => {
                    mockData[cat] = Math.floor(Math.random() * 50) + 10;
                });

                // Update chart
                chartInstance.data.datasets[0].data = Object.values(mockData);
                chartInstance.data.datasets[0].label = `Pelaporan - ${selectedDate}`;
                chartInstance.update('active');

                // Update table
                const tableBody = document.querySelector('#tableHarianBody');
                if (tableBody) {
                    tableBody.innerHTML = '';
                    const total = Object.values(mockData).reduce((a, b) => a + b, 0);
                    Object.entries(mockData).forEach(([category, value]) => {
                        const percentage = ((value / total) * 100).toFixed(1);
                        const tr = document.createElement('tr');
                        const tdCat = document.createElement('td'); const strongCat = document.createElement('strong'); strongCat.textContent = category; tdCat.appendChild(strongCat); tr.appendChild(tdCat);
                        const tdVal = document.createElement('td'); tdVal.className = 'text-end'; const span = document.createElement('span'); span.className = 'badge bg-primary'; span.textContent = value; tdVal.appendChild(span); tr.appendChild(tdVal);
                        const tdPerc = document.createElement('td'); tdPerc.className = 'text-end'; tdPerc.textContent = percentage + '%'; tr.appendChild(tdPerc);
                        tableBody.appendChild(tr);
                    });
                }
            } catch (error) {
                console.error('Error loading harian data:', error);
            }
        }

        function loadBulanData() {
            try {
                const selectedMonth = document.getElementById('monthSelector').value;
                const chartInstance = charts.bulanan;
                
                if (!selectedMonth || !chartInstance) return;

                const categories = ['STBLKK', 'PB', 'Asuransi Baru', 'Asuransi Lama', 'BBM Subsidi', 'BBM Non-Subsidi'];
                const colors = ['#1e3a8a', '#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#0891b2'];

                // Generate data for 4 weeks
                chartInstance.data.datasets = categories.map((cat, idx) => ({
                    label: cat,
                    data: [
                        Math.floor(Math.random() * 60) + 30,
                        Math.floor(Math.random() * 70) + 35,
                        Math.floor(Math.random() * 65) + 32,
                        Math.floor(Math.random() * 75) + 40
                    ],
                    backgroundColor: colors[idx]
                }));
                chartInstance.update('active');

                // Update table
                const tableBody = document.querySelector('#tableBulanBody');
                if (tableBody) {
                    tableBody.innerHTML = '';
                    const weeks = ['Minggu 1', 'Minggu 2', 'Minggu 3', 'Minggu 4'];
                    weeks.forEach((week, idx) => {
                        const total = chartInstance.data.datasets.reduce((sum, ds) => sum + ds.data[idx], 0);
                        const avg = Math.round(total / chartInstance.data.datasets.length);
                        const tr = document.createElement('tr');
                        const tdWeek = document.createElement('td'); const strongWeek = document.createElement('strong'); strongWeek.textContent = week; tdWeek.appendChild(strongWeek); tr.appendChild(tdWeek);
                        const tdTot = document.createElement('td'); tdTot.className = 'text-end'; const span = document.createElement('span'); span.className = 'badge bg-success'; span.textContent = total; tdTot.appendChild(span); tr.appendChild(tdTot);
                        const tdAvg = document.createElement('td'); tdAvg.className = 'text-end'; tdAvg.textContent = avg; tr.appendChild(tdAvg);
                        tableBody.appendChild(tr);
                    });
                }
            } catch (error) {
                console.error('Error loading bulanan data:', error);
            }
        }

        function loadTahunData() {
            try {
                const selectedYear = document.getElementById('yearSelector').value;
                const chartInstance = charts.tahunan;
                
                if (!selectedYear || !chartInstance) return;

                const categories = ['STBLKK', 'PB', 'Asuransi Baru', 'Asuransi Lama', 'BBM Subsidi', 'BBM Non-Subsidi'];
                const colors = ['#1e3a8a', '#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#0891b2'];

                // Generate data for 12 months
                chartInstance.data.datasets = categories.map((cat, idx) => ({
                    label: cat,
                    data: Array.from({length: 12}, () => Math.floor(Math.random() * 80) + 50),
                    backgroundColor: colors[idx]
                }));
                chartInstance.update('active');

                // Update table
                const tableBody = document.querySelector('#tableTahunBody');
                if (tableBody) {
                    tableBody.innerHTML = '';
                    const months = ['Jan', 'Feb', 'Mar', 'Apr', 'Mei', 'Jun', 'Jul', 'Agu', 'Sep', 'Okt', 'Nov', 'Des'];
                    months.forEach((month, idx) => {
                        const total = chartInstance.data.datasets.reduce((sum, ds) => sum + ds.data[idx], 0);
                        const avg = Math.round(total / chartInstance.data.datasets.length);
                        const tr = document.createElement('tr');
                        const tdMonth = document.createElement('td'); const strongMonth = document.createElement('strong'); strongMonth.textContent = month; tdMonth.appendChild(strongMonth); tr.appendChild(tdMonth);
                        const tdTot = document.createElement('td'); tdTot.className = 'text-end'; const span = document.createElement('span'); span.className = 'badge bg-info'; span.textContent = total; tdTot.appendChild(span); tr.appendChild(tdTot);
                        const tdAvg = document.createElement('td'); tdAvg.className = 'text-end'; tdAvg.textContent = avg; tr.appendChild(tdAvg);
                        tableBody.appendChild(tr);
                    });
                }
            } catch (error) {
                console.error('Error loading tahunan data:', error);
            }
        }

        // Initialize with today's date and load initial data
        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('daySelector').value = today;
            document.getElementById('yearSelector').value = new Date().getFullYear();
            
            // Load initial data
            setTimeout(() => {
                loadHarianData();
                loadBulanData();
                loadTahunData();
            }, 500);
        });
    </script>
</body>
</html>
