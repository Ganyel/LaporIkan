<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - PPN Tegalsari</title>

    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/style.css">
</head>
<body class="page-admin">
    <!-- Header with Logo -->
    <header class="ppn-header">
        <div class="container-fluid">
            <a href="/" class="header-link">
                <div class="header-content">
                    <div class="logo-section">
                        <div class="logo-group">
                            <img src="/images/Logo2.png" alt="Logo PPN Tegalsari 2" class="ppn-logo">
                            <img src="/images/Logo1.png" alt="Logo PPN Tegalsari" class="ppn-logo">
                        </div>
                    </div>
                    <div class="institution-section">
                        <h1>PELABUHAN PERIKANAN NUSANTARA</h1>
                        <h2>TEGALSARI</h2>
                    </div>
                </div>
            </a>
        </div>
    </header>

    <!-- Navigation Bar -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <span class="navbar-brand">Admin Panel<small>PPN Tegalsari</small></span>
            <div class="ms-auto">
                <a href="/" class="btn btn-sm btn-outline-light fw-bold me-2">Beranda</a>
                <a href="/login" class="btn btn-sm btn-light fw-bold">Logout</a>
            </div>
        </div>
    </nav>

    <!-- Main Container -->
    <div class="container-main">
        <!-- Page Header -->
        <div class="page-header">
            <h1>Admin Panel</h1>
            <p>Kelola data pelaporan harian dan ikan</p>
        </div>

        <!-- Alert Container -->
        <div id="alertContainer"></div>

        <!-- Tab Navigation -->
        <ul class="nav nav-tabs mb-4" id="adminTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="laporanTab" data-bs-toggle="tab" data-bs-target="#laporanContent" type="button">
                    Input Infografis
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="ikanTab" data-bs-toggle="tab" data-bs-target="#ikanContent" type="button">
                    Input Ikan
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="googleSheetsTab" data-bs-toggle="tab" data-bs-target="#googleSheetsContent" type="button">
                    Google Sheets
                </button>
            </li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content" id="adminTabContent">
            <!-- Laporan Tab -->
            <div class="tab-pane fade show active" id="laporanContent" role="tabpanel">
                <div class="card mb-4">
                    <div class="card-header">Form Input Data Harian</div>
                    <div class="card-body">
                        <form id="formLaporan" onsubmit="submitForm(event)">
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label" for="tanggal">Tanggal *</label>
                                    <input type="date" id="tanggal" class="form-control" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label" for="stblkk">STBLKK</label>
                                    <input type="number" id="stblkk" class="form-control" value="0">
                                </div>
                                <div class="form-group">
                                    <label class="form-label" for="pb">PB</label>
                                    <input type="number" id="pb" class="form-control" value="0">
                                </div>
                                <div class="form-group">
                                    <label class="form-label" for="asuransi_baru">Asuransi Baru</label>
                                    <input type="number" id="asuransi_baru" class="form-control" value="0">
                                </div>
                                <div class="form-group">
                                    <label class="form-label" for="asuransi_lama">Asuransi Lama</label>
                                    <input type="number" id="asuransi_lama" class="form-control" value="0">
                                </div>
                                <div class="form-group">
                                    <label class="form-label" for="bbm_subsidi_surat">BBM Subsidi Surat</label>
                                    <input type="number" id="bbm_subsidi_surat" class="form-control" value="0">
                                </div>
                                <div class="form-group">
                                    <label class="form-label" for="bbm_non_surat">BBM Non Surat</label>
                                    <input type="number" id="bbm_non_surat" class="form-control" value="0">
                                </div>
                            </div>
                            <button type="submit" class="btn btn-primary">Simpan Data</button>
                        </form>
                    </div>
                </div>

                <!-- Data Table -->
                <div class="card">
                    <div class="card-header">Data Infografis</div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>Tanggal</th>
                                        <th class="text-end">STBLKK</th>
                                        <th class="text-end">PB</th>
                                        <th class="text-end">Asuransi Baru</th>
                                        <th class="text-end">Asuransi Lama</th>
                                        <th class="text-end">BBM Subsidi</th>
                                        <th class="text-end">BBM Non Surat</th>
                                        <th class="text-center">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="tableLaporanBody">
                                    <tr>
                                        <td colspan="8" class="text-center text-muted">Memuat data...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        <div class="tab-pane fade" id="ikanContent" role="tabpanel">
            <!-- Form Input Section -->
            <div class="row">
                <div class="col-lg-6">
                    <div class="card mb-4">
                        <div class="card-header">Form Input/Edit Ikan</div>
                        <div class="card-body">
                            <form id="formIkan" onsubmit="submitFormIkan(event)">
                                <div class="form-group mb-3">
                                    <label class="form-label" for="namaIkan">Nama Ikan *</label>
                                    <input type="text" id="namaIkan" class="form-control" placeholder="Contoh: Ikan Lele" required>
                                    <small class="text-muted">Masukkan nama jenis ikan</small>
                                </div>

                                <div class="form-group mb-3">
                                    <label class="form-label" for="jumlahIkan">Jumlah (ton) *</label>
                                    <input type="number" id="jumlahIkan" class="form-control" min="1" placeholder="0" required>
                                    <small class="text-muted">Masukkan jumlah ikan dalam ton</small>
                                </div>

                                <div class="form-group mb-3">
                                    <label class="form-label" for="fotoIkan">Foto Ikan</label>
                                    <input type="file" id="fotoIkan" class="form-control" accept="image/*">
                                    <small class="text-muted">Format: JPG, PNG, GIF (Max 5MB) - Opsional</small>
                                </div>

                                <div class="form-group mb-3">
                                    <div id="previewFoto"></div>
                                </div>

                                <div class="d-grid gap-2">
                                    <button type="submit" class="btn btn-primary btn-lg">
                                        Simpan Data Ikan
                                    </button>
                                    <button type="reset" class="btn btn-secondary" onclick="resetFormIkan()">Reset Form</button>
                                </div>

                                <div id="editInfo" style="display: none; margin-top: 1rem;">
                                    <div class="alert alert-info mb-0">
                                        <small>
                                            Mode Edit - Klik "Reset Form" untuk membuat data baru
                                            <button type="button" class="btn-close btn-sm float-end" onclick="resetFormIkan()" style="padding: 0;"></button>
                                        </small>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Preview & Info Section -->
                <div class="col-lg-6">
                    <div class="card mb-4">
                        <div class="card-header">Informasi Data Ikan</div>
                        <div class="card-body text-center">
                            <div id="infoContent">
                                <p class="text-muted">Isi form di sebelah kiri untuk melihat preview data</p>
                                <div style="font-size: 4rem; color: #ccc;">&nbsp;</div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">Statistik Ikan</div>
                        <div class="card-body">
                            <div class="mb-3">
                                <small class="text-muted">TOTAL JENIS IKAN</small>
                                <div style="font-size: 2rem; font-weight: bold; color: #1e3a8a;" id="statTotal">0</div>
                            </div>
                            <div class="mb-3">
                                <small class="text-muted">TOTAL TON IKAN</small>
                                <div style="font-size: 2rem; font-weight: bold; color: #10b981;" id="statEkor">0</div>
                            </div>
                            <button class="btn btn-outline-primary btn-sm w-100" onclick="loadIkanDataList()">
                                Refresh Data
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Data Table Section -->
            <div class="card mt-4">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <span>Daftar Ikan yang Sudah Diinput</span>
                        <button class="btn btn-primary btn-sm" onclick="loadIkanDataList()">Refresh</button>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Foto</th>
                                <th>Nama Ikan</th>
                                <th class="text-end">Jumlah (ton)</th>
                                <th>Tanggal Input</th>
                                <th class="text-center">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="tableIkanBody">
                            <tr>
                                <td colspan="5" class="text-center text-muted py-4">Memuat data...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    
    </div>

    

        <!-- Google Sheets Tab -->
        <div class="tab-pane fade" id="googleSheetsContent" role="tabpanel">
            <div class="card mb-4 gs-config-card">
                <div class="card-header">
                    <h5 class="mb-0">Konfigurasi Spreadsheet</h5>
                </div>
                <div class="card-body">
                    <div class="row g-3 align-items-end gs-config-row">
                        <div class="col-lg-8">
                            <label class="form-label" for="gsSpreadsheetUrl">Link Spreadsheet atau Spreadsheet ID</label>
                            <input type="text" id="gsSpreadsheetUrl" class="form-control" placeholder="Tempel link Google Sheets di sini">
                        </div>
                        <div class="col-lg-4 d-grid gs-config-action">
                            <button class="btn btn-primary gs-config-button" type="button" onclick="saveSpreadsheetConfig()">Simpan</button>
                        </div>
                    </div>
                    <div class="row gs-config-help-row">
                        <div class="col-12">
                            <small class="text-muted">Contoh: https://docs.google.com/spreadsheets/d/XXXX/edit</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Google Sheets Tabs -->
            <ul class="nav nav-tabs mb-4" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="gsLaporanTab" data-bs-toggle="tab" data-bs-target="#gsLaporanContent" type="button">
                        Data Laporan Harian
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="gsIkanTab" data-bs-toggle="tab" data-bs-target="#gsIkanContent" type="button">
                        Data Ikan
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="gsSyncTab" data-bs-toggle="tab" data-bs-target="#gsSyncContent" type="button">
                        Sinkronisasi
                    </button>
                </li>
            </ul>

            <div class="tab-content">
                <!-- Google Sheets Laporan -->
                <div class="tab-pane fade show active" id="gsLaporanContent" role="tabpanel">
                    <div class="card mb-4">
                        <div class="card-header">Data Infografis dari Google Sheets</div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-striped" id="gsLaporanTable">
                                    <thead>
                                        <tr>
                                            <th>No</th>
                                            <th>Waktu</th>
                                            <th>Tanggal</th>
                                            <th>Data Tangkapan</th>
                                            <th>Data Layanan</th>
                                            <th>Catatan</th>
                                        </tr>
                                    </thead>
                                    <tbody id="gsLaporanTableBody">
                                        <tr>
                                            <td colspan="6" class="text-center text-muted">
                                                <span class="spinner-border spinner-border-sm me-2"></span>
                                                Mengambil data...
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div class="mt-3">
                                <button class="btn btn-primary btn-sm" onclick="refreshGSLaporanData()">
                                    Refresh
                                </button>
                                <button class="btn btn-danger btn-sm" onclick="clearGSLaporanSheet()">
                                    Clear Sheet
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Google Sheets Ikan -->
                <div class="tab-pane fade" id="gsIkanContent" role="tabpanel">
                    <div class="card mb-4">
                        <div class="card-header">Data Ikan dari Google Sheets</div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-striped" id="gsIkanTable">
                                    <thead>
                                        <tr>
                                            <th>No</th>
                                            <th>Waktu Sync</th>
                                            <th>ID Ikan</th>
                                            <th>Nama Ikan</th>
                                            <th>Harga Estimasi</th>
                                            <th>Stok</th>
                                            <th>Asal</th>
                                        </tr>
                                    </thead>
                                    <tbody id="gsIkanTableBody">
                                        <tr>
                                            <td colspan="7" class="text-center text-muted">
                                                <span class="spinner-border spinner-border-sm me-2"></span>
                                                Mengambil data...
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div class="mt-3">
                                <button class="btn btn-primary btn-sm" onclick="refreshGSIkanData()">
                                    Refresh
                                </button>
                                <button class="btn btn-danger btn-sm" onclick="clearGSIkanSheet()">
                                    Clear Sheet
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Google Sheets Sync -->
                <div class="tab-pane fade" id="gsSyncContent" role="tabpanel">
                    <div class="card mb-4">
                        <div class="card-header">Opsi Sinkronisasi</div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-body">
                                            <h6 class="card-title">Sync dari Aplikasi ke Sheet</h6>
                                            <p class="text-muted small">Kirim semua data infografis ke Google Sheets</p>
                                            <button class="btn btn-success w-100" onclick="syncAllToSheet()">
                                                Sinkronkan Laporan
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-body">
                                            <h6 class="card-title">Import dari Sheet ke Aplikasi</h6>
                                            <p class="text-muted small">Ambil data dari Google Sheets ke database</p>
                                            <button class="btn btn-info w-100" onclick="importFromSheet()">
                                                Import dari Sheet
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <hr class="my-4">

                            <h6 class="mb-3">Manual Sync Data</h6>
                            <form id="manualSyncForm">
                                <div class="mb-3">
                                    <label class="form-label">Tipe Data</label>
                                    <select class="form-select" id="syncType" required>
                                        <option value="">-- Pilih Tipe Data --</option>
                                        <option value="laporan">Infografis</option>
                                        <option value="ikan">Data Ikan</option>
                                    </select>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Data (JSON)</label>
                                    <textarea class="form-control" id="syncData" rows="6" 
                                        placeholder='{"id": "001", ...}'></textarea>
                                </div>

                                <button type="submit" class="btn btn-primary">
                                    Sync Data
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        </div>
    <footer class="footer">
        <div class="footer-content">
            <div class="footer-col footer-brand">
                <div class="footer-brand-row">
                    <div class="footer-logos">
                        <img src="/images/Logo2.png" alt="Logo PPN Tegalsari 2" class="footer-logo">
                        <img src="/images/Logo1.png" alt="Logo PPN Tegalsari" class="footer-logo">
                    </div>
                    <div>
                        <div class="footer-title">PELABUHAN PERIKANAN NUSANTARA</div>
                        <div class="footer-subtitle">TEGALSARI</div>
                    </div>
                </div>
                <p class="footer-text">Jl. Blanak No.10C, Tegalsari, Kec. Tegal Bar., Kota Tegal, Jawa Tengah 52111</p>
            </div>
            <div class="footer-col">
                <div class="footer-title">Kontak</div>
                <ul class="footer-list">
                    <li>Telp: (0283) 358787</li>
                    <li>Fax: (0283) 321366</li>
                    <li>Email: p3tegalsari@gmail.com</li>
                </ul>
            </div>
            <div class="footer-col">
                <div class="footer-title">Media Sosial</div>
                <div class="footer-social">
                    <a href="#" aria-label="Facebook"><i class="bi bi-facebook"></i></a>
                    <a href="#" aria-label="Instagram"><i class="bi bi-instagram"></i></a>
                    <a href="#" aria-label="TikTok"><i class="bi bi-tiktok"></i></a>
                    <a href="#" aria-label="YouTube"><i class="bi bi-youtube"></i></a>
                    <a href="tel:+62283358787" aria-label="Telepon"><i class="bi bi-telephone"></i></a>
                    <a href="mailto:p3tegalsari@gmail.com" aria-label="Email"><i class="bi bi-envelope"></i></a>
                </div>
            </div>
            <div class="footer-col footer-map">
                <div class="footer-title">Lokasi</div>
                <div class="footer-map-embed">
                    <iframe
                        title="PPN Tegalsari Map"
                        loading="lazy"
                        referrerpolicy="no-referrer-when-downgrade"
                        src="https://www.google.com/maps?q=Jl.%20Blanak%20No.10C%2C%20Tegalsari%2C%20Kec.%20Tegal%20Bar.%2C%20Kota%20Tegal%2C%20Jawa%20Tengah%2052111&output=embed">
                    </iframe>
                </div>
            </div>
        </div>
        <div class="footer-bottom">
            <p>&copy; <span id="footerYear"></span> PPN Tegalsari. Semua hak dilindungi.</p>
        </div>
    </footer>

    <!-- Bootstrap 5 JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Custom JS -->
    <script src="/js/admin.js"></script>
    
    <!-- Google Sheets Integration Script -->
    <script>
        const footerYear = document.getElementById('footerYear');
        if (footerYear) {
            footerYear.textContent = new Date().getFullYear();
        }

        function getAdminToken() {
            return localStorage.getItem('adminToken') || sessionStorage.getItem('adminToken');
        }

        function getAuthHeaders() {
            const token = getAdminToken();
            return token ? { Authorization: `Bearer ${token}` } : {};
        }

        function fetchWithAuth(url, options = {}) {
            const token = getAdminToken();
            if (!token) {
                window.location.href = '/login';
                return Promise.reject(new Error('Token tidak ditemukan'));
            }
            const headers = {
                ...(options.headers || {}),
                Authorization: `Bearer ${token}`
            };
            return fetch(url, { ...options, headers });
        }

        // Check connection status
        async function checkGSConnectionStatus() {
            try {
                const status = document.getElementById('gsConnectionStatus');
                if (!status) return;
                const response = await fetchWithAuth('/api/data-sheet/laporan-harian');
                const result = await response.json();

                if (result.success) {
                    status.innerHTML = '';
                    const span = document.createElement('span');
                    span.className = 'badge bg-success';
                    span.textContent = 'Terhubung ke Google Sheets';
                    status.appendChild(span);
                    refreshGSLaporanData();
                    refreshGSIkanData();
                } else {
                    throw new Error(result.error || result.message || 'Koneksi gagal');
                }
            } catch (error) {
                    const status = document.getElementById('gsConnectionStatus');
                    if (!status) return;
                    status.innerHTML = '';
                    const span = document.createElement('span');
                    span.className = 'badge bg-warning';
                    span.textContent = 'Google Sheets tidak tersedia: ' + error.message;
                    status.appendChild(span);
            }
        }

        // Refresh laporan data dari Google Sheets
        async function refreshGSLaporanData() {
            try {
                const response = await fetchWithAuth('/api/data-sheet/laporan-harian');
                const result = await response.json();

                if (!result.success) {
                    throw new Error(result.error || result.message || 'Gagal mengambil data');
                }

                const tbody = document.getElementById('gsLaporanTableBody');
                tbody.innerHTML = '';

                if (result.data && result.data.length > 0) {
                    result.data.forEach((row, index) => {
                        const tr = document.createElement('tr');

                        const tdIndex = document.createElement('td');
                        tdIndex.textContent = index + 1;
                        tr.appendChild(tdIndex);

                        const makeCell = (value) => {
                            const td = document.createElement('td');
                            td.textContent = value != null && value !== '' ? value : '-';
                            return td;
                        };

                        tr.appendChild(makeCell(row[0]));
                        tr.appendChild(makeCell(row[1]));

                        const tdSmall2 = document.createElement('td');
                        const small2 = document.createElement('small');
                        small2.textContent = row[2] != null && row[2] !== '' ? row[2] : '-';
                        tdSmall2.appendChild(small2);
                        tr.appendChild(tdSmall2);

                        const tdSmall3 = document.createElement('td');
                        const small3 = document.createElement('small');
                        small3.textContent = row[3] != null && row[3] !== '' ? row[3] : '-';
                        tdSmall3.appendChild(small3);
                        tr.appendChild(tdSmall3);

                        tr.appendChild(makeCell(row[4]));

                        tbody.appendChild(tr);
                    });
                } else {
                    const tr = document.createElement('tr');
                    const td = document.createElement('td');
                    td.setAttribute('colspan', '6');
                    td.className = 'text-center text-muted';
                    td.textContent = 'Tidak ada data';
                    tr.appendChild(td);
                    tbody.appendChild(tr);
                }
            } catch (error) {
                console.error('Error:', error);
                const tbody = document.getElementById('gsLaporanTableBody');
                if (tbody) {
                    tbody.innerHTML = '';
                    const tr = document.createElement('tr');
                    const td = document.createElement('td');
                    td.setAttribute('colspan', '6');
                    td.className = 'text-center text-danger';
                    td.textContent = 'Gagal mengambil data: ' + error.message;
                    tr.appendChild(td);
                    tbody.appendChild(tr);
                }
            }
        }

        // Refresh ikan data dari Google Sheets
        async function refreshGSIkanData() {
            try {
                const response = await fetchWithAuth('/api/data-sheet/ikan');
                const result = await response.json();

                if (!result.success) {
                    throw new Error(result.error || result.message || 'Gagal mengambil data');
                }

                const tbody = document.getElementById('gsIkanTableBody');
                tbody.innerHTML = '';

                if (result.data && result.data.length > 0) {
                    result.data.forEach((row, index) => {
                        const tr = document.createElement('tr');

                        const tdIndex = document.createElement('td');
                        tdIndex.textContent = index + 1;
                        tr.appendChild(tdIndex);

                        const makeCell = (value) => {
                            const td = document.createElement('td');
                            td.textContent = value != null && value !== '' ? value : '-';
                            return td;
                        };

                        tr.appendChild(makeCell(row[0]));
                        tr.appendChild(makeCell(row[1]));
                        tr.appendChild(makeCell(row[2]));
                        tr.appendChild(makeCell(row[3]));
                        tr.appendChild(makeCell(row[4]));
                        tr.appendChild(makeCell(row[5]));

                        tbody.appendChild(tr);
                    });
                } else {
                    const tr = document.createElement('tr');
                    const td = document.createElement('td');
                    td.setAttribute('colspan', '7');
                    td.className = 'text-center text-muted';
                    td.textContent = 'Tidak ada data';
                    tr.appendChild(td);
                    tbody.appendChild(tr);
                }
            } catch (error) {
                console.error('Error:', error);
                const tbody = document.getElementById('gsIkanTableBody');
                if (tbody) {
                    tbody.innerHTML = '';
                    const tr = document.createElement('tr');
                    const td = document.createElement('td');
                    td.setAttribute('colspan', '7');
                    td.className = 'text-center text-danger';
                    td.textContent = 'Gagal mengambil data: ' + error.message;
                    tr.appendChild(td);
                    tbody.appendChild(tr);
                }
            }
        }

        async function saveSpreadsheetConfig() {
            const input = document.getElementById('gsSpreadsheetUrl');
            const sheetUrl = input?.value?.trim();

            if (!sheetUrl) {
                if (typeof showAlert === 'function') showAlert('Link Spreadsheet harus diisi', 'danger');
                return;
            }

            try {
                const response = await fetchWithAuth('/api/data-sheet/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ sheetUrl })
                });
                const result = await response.json();

                if (!response.ok || !result.success) {
                    throw new Error(result.message || result.error || 'Gagal menyimpan Spreadsheet ID');
                }

                if (typeof showAlert === 'function') {
                    showAlert('✅ Spreadsheet ID berhasil disimpan. Sedang memuat data...', 'success');
                }
                refreshGSLaporanData();
                refreshGSIkanData();
            } catch (error) {
                if (typeof showAlert === 'function') {
                    showAlert('❌ ' + error.message, 'danger');
                }
            }
        }

        // Clear laporan sheet
        async function clearGSLaporanSheet() {
            if (!confirm('Apakah Anda yakin ingin menghapus semua data di sheet ini?')) return;

            try {
                const response = await fetchWithAuth('/api/data-sheet/clear/Laporan%20Harian', {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (result.success) {
                    showAlert('Sheet berhasil dikosongkan', 'success');
                    refreshGSLaporanData();
                } else {
                    showAlert('Error: ' + result.message, 'danger');
                }
            } catch (error) {
                showAlert('Error: ' + error.message, 'danger');
            }
        }

        // Clear ikan sheet
        async function clearGSIkanSheet() {
            if (!confirm('Apakah Anda yakin ingin menghapus semua data di sheet ini?')) return;

            try {
                const response = await fetchWithAuth('/api/data-sheet/clear/Data%20Ikan', {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (result.success) {
                    showAlert('Sheet berhasil dikosongkan', 'success');
                    refreshGSIkanData();
                } else {
                    showAlert('Error: ' + result.message, 'danger');
                }
            } catch (error) {
                showAlert('Error: ' + error.message, 'danger');
            }
        }

        // Sync all to sheet (placeholder)
        async function syncAllToSheet() {
            showAlert('Fitur sync bulk belum diimplementasikan', 'info');
        }

        // Import from sheet (placeholder)
        async function importFromSheet() {
            showAlert('Fitur import belum diimplementasikan', 'info');
        }

        // Manual sync
        document.getElementById('manualSyncForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const type = document.getElementById('syncType').value;
            const data = document.getElementById('syncData').value;

            try {
                const parsedData = JSON.parse(data);
                const endpoint = type === 'laporan' ? 
                    '/api/data-sheet/sync-laporan-harian' : 
                    '/api/data-sheet/sync-ikan';

                const response = await fetchWithAuth(endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(parsedData)
                });

                const result = await response.json();

                if (result.success) {
                    showAlert('Data berhasil disync', 'success');
                    document.getElementById('manualSyncForm').reset();
                    if (type === 'laporan') {
                        refreshGSLaporanData();
                    } else {
                        refreshGSIkanData();
                    }
                } else {
                    showAlert('Error: ' + result.message, 'danger');
                }
            } catch (error) {
                showAlert('Error: ' + error.message, 'danger');
            }
        });

        // Initialize Google Sheets on page load
        window.addEventListener('load', () => {
            // Load ikan data saat tab ikan di-klik
            loadIkanDataList();
        });

        // ============ FUNCTIONS UNTUK INPUT IKAN ============

        // Submit form ikan
        async function submitFormIkan(event) {
            event.preventDefault();

            const namaIkan = document.getElementById('namaIkan').value.trim();
            const jumlahIkan = parseInt(document.getElementById('jumlahIkan').value, 10);
            const fotoIkan = document.getElementById('fotoIkan').files[0];
            const idIkanEdit = document.getElementById('formIkan').getAttribute('data-id-edit');

            if (!namaIkan) {
                showAlert('Nama ikan harus diisi', 'danger');
                return;
            }

            if (!jumlahIkan || jumlahIkan <= 0) {
                showAlert('Jumlah ikan harus lebih dari 0', 'danger');
                return;
            }

            let foto = undefined;
            if (fotoIkan) {
                if (fotoIkan.size > 5 * 1024 * 1024) {
                    showAlert('Ukuran foto terlalu besar (max 5MB)', 'danger');
                    return;
                }

                const reader = new FileReader();
                foto = await new Promise((resolve) => {
                    reader.onload = () => resolve(reader.result);
                    reader.readAsDataURL(fotoIkan);
                });
            }

            const payload = {
                nama_ikan: namaIkan,
                jumlah: jumlahIkan
            };

            if (foto !== undefined) {
                payload.foto = foto;
            }

            try {
                const method = idIkanEdit ? 'PUT' : 'POST';
                const endpoint = idIkanEdit ? `/api/ikan/${idIkanEdit}` : '/api/ikan';

                const response = await fetchWithAuth(endpoint, {
                    method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (result.success) {
                    showAlert(idIkanEdit ? 'Data ikan berhasil diupdate' : 'Data ikan berhasil disimpan', 'success');
                    resetFormIkan();
                    loadIkanDataList();
                } else {
                    showAlert('Error: ' + result.message, 'danger');
                }
            } catch (error) {
                showAlert('Error: ' + error.message, 'danger');
            }
        }

        // Load ikan data list
        async function loadIkanDataList() {
            try {
                const response = await fetch('/api/ikan', {
                    headers: {
                        ...getAuthHeaders()
                    }
                });
                const result = await response.json();

                if (result.success) {
                    const tbody = document.getElementById('tableIkanBody');
                    tbody.innerHTML = '';

                    let totalJenis = 0;
                    let totalEkor = 0;

                    if (result.data && result.data.length > 0) {
                        result.data.forEach(ikan => {
                            totalJenis++;
                            totalEkor += parseInt(ikan.jumlah) || 0;

                            const tanggalInput = new Date(ikan.created_at).toLocaleDateString('id-ID');
                            const tr = document.createElement('tr');

                            const tdFoto = document.createElement('td');
                            if (ikan.foto) {
                                const img = document.createElement('img');
                                img.src = ikan.foto;
                                img.style.height = '50px';
                                img.style.borderRadius = '5px';
                                tdFoto.appendChild(img);
                            } else {
                                const span = document.createElement('span');
                                span.className = 'text-muted';
                                span.textContent = '-';
                                tdFoto.appendChild(span);
                            }
                            tr.appendChild(tdFoto);

                            const tdNama = document.createElement('td');
                            tdNama.textContent = ikan.nama_ikan || '-';
                            tr.appendChild(tdNama);

                            const tdJumlah = document.createElement('td');
                            tdJumlah.className = 'text-end';
                            tdJumlah.textContent = (ikan.jumlah || 0) + ' ton';
                            tr.appendChild(tdJumlah);

                            const tdTanggal = document.createElement('td');
                            tdTanggal.textContent = tanggalInput;
                            tr.appendChild(tdTanggal);

                            const tdAksi = document.createElement('td');
                            tdAksi.className = 'text-center';
                            const btnEdit = document.createElement('button');
                            btnEdit.className = 'btn btn-sm btn-warning';
                            btnEdit.type = 'button';
                            btnEdit.textContent = 'Edit';
                            btnEdit.addEventListener('click', () => editIkan(ikan.id));
                            const btnDel = document.createElement('button');
                            btnDel.className = 'btn btn-sm btn-danger';
                            btnDel.type = 'button';
                            btnDel.textContent = 'Hapus';
                            btnDel.addEventListener('click', () => deleteIkan(ikan.id));
                            tdAksi.appendChild(btnEdit);
                            tdAksi.appendChild(btnDel);
                            tr.appendChild(tdAksi);

                            tbody.appendChild(tr);
                        });
                    } else {
                        const tr = document.createElement('tr');
                        const td = document.createElement('td');
                        td.setAttribute('colspan','5');
                        td.className = 'text-center text-muted py-4';
                        td.textContent = 'Belum ada data ikan';
                        tr.appendChild(td);
                        tbody.appendChild(tr);
                    }

                    document.getElementById('statTotal').innerText = totalJenis;
                    document.getElementById('statEkor').innerText = totalEkor.toLocaleString('id-ID');
                } else {
                    showAlert('Error: ' + result.message, 'danger');
                }
            } catch (error) {
                showAlert('Error: ' + error.message, 'danger');
            }
        }

        // Reset form ikan
        function resetFormIkan() {
            document.getElementById('formIkan').reset();
            document.getElementById('formIkan').removeAttribute('data-id-edit');
            const preview = document.getElementById('previewFoto');
            if (preview) preview.textContent = '';
            const info = document.getElementById('infoContent');
            if (info) {
                info.innerHTML = '';
                const p = document.createElement('p');
                p.className = 'text-muted';
                p.textContent = 'Isi form di sebelah kiri untuk melihat preview data';
                const div = document.createElement('div');
                div.style.fontSize = '4rem';
                div.style.color = '#ccc';
                div.textContent = '';
                info.appendChild(p);
                info.appendChild(div);
            }
            const editInfo = document.getElementById('editInfo');
            if (editInfo) editInfo.style.display = 'none';
        }

        // Edit ikan
        async function editIkan(id) {
            try {
                const response = await fetchWithAuth(`/api/ikan/${id}`);
                const result = await response.json();

                if (!result.success) {
                    throw new Error(result.message);
                }

                const data = result.data;
                document.getElementById('namaIkan').value = data.nama_ikan || '';
                document.getElementById('jumlahIkan').value = data.jumlah || 0;
                document.getElementById('formIkan').setAttribute('data-id-edit', id);

                const editInfo = document.getElementById('editInfo');
                if (editInfo) editInfo.style.display = 'block';

                const previewDiv = document.getElementById('previewFoto');
                if (previewDiv) {
                    previewDiv.innerHTML = '';
                    if (data.foto) {
                        const img = document.createElement('img');
                        img.src = data.foto;
                        img.style.maxWidth = '100%';
                        img.style.maxHeight = '300px';
                        img.style.borderRadius = '10px';
                        previewDiv.appendChild(img);
                    }
                }

                const info = document.getElementById('infoContent');
                if (info) {
                    info.innerHTML = '';
                    const h5 = document.createElement('h5');
                    h5.textContent = data.nama_ikan || '-';
                    const p = document.createElement('p');
                    p.textContent = `${data.jumlah || 0} ton`;
                    const div = document.createElement('div');
                    div.style.fontSize = '3rem';
                    div.textContent = '';
                    info.appendChild(h5);
                    info.appendChild(p);
                    info.appendChild(div);
                }

                document.getElementById('formIkan').scrollIntoView({ behavior: 'smooth' });
            } catch (error) {
                showAlert('Error: ' + error.message, 'danger');
            }
        }

        // Delete ikan
        async function deleteIkan(id) {
            if (!confirm('Apakah Anda yakin ingin menghapus data ini?')) return;

            try {
                const response = await fetchWithAuth(`/api/ikan/${id}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (result.success) {
                    showAlert('Data ikan berhasil dihapus', 'success');
                    loadIkanDataList();
                } else {
                    showAlert('Error: ' + result.message, 'danger');
                }
            } catch (error) {
                showAlert('Error: ' + error.message, 'danger');
            }
        }

        // Update preview foto
        document.addEventListener('change', function(e) {
            if (e.target.id === 'fotoIkan') {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        const preview = document.getElementById('previewFoto');
                        preview.innerHTML = '';
                        const img = document.createElement('img');
                        img.src = event.target.result;
                        img.style.maxWidth = '100%';
                        img.style.maxHeight = '300px';
                        img.style.borderRadius = '10px';
                        preview.appendChild(img);
                    };
                    reader.readAsDataURL(file);
                }
            }
        });

        // Update info preview saat form berubah
        document.getElementById('namaIkan')?.addEventListener('change', function() {
            const nama = this.value;
            const jumlah = document.getElementById('jumlahIkan').value;
            if (nama) {
                const info = document.getElementById('infoContent');
                info.innerHTML = '';
                const h5 = document.createElement('h5');
                h5.textContent = nama;
                const p = document.createElement('p');
                p.textContent = `${jumlah} ton`;
                const div = document.createElement('div');
                div.style.fontSize = '3rem';
                div.textContent = '';
                info.appendChild(h5);
                info.appendChild(p);
                info.appendChild(div);
            }
        });
    </script>
</body>
</html>
